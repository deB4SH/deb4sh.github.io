<!DOCTYPE html>
 <html lang="en"> 
<head>
  <meta charset="utf-8">
  
  <title>Automating Kubernetes on Proxmox - A Platform Engineer&#39;s Best Friend | log.out(&#34;blog&#34;)</title>
  <meta name="author" content="deB4SH">

  
  <meta name="description" content="a journey between software and ops topics">
  

  
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  <!--[if lt IE 9]><script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <header id="header" class="inner"><nav>
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
</nav></header>
  <div id="content" class="inner"><article class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <header>
    
  
    <h1 class="p-name title" itemprop="headline name">Automating Kubernetes on Proxmox - A Platform Engineer&#39;s Best Friend</h1>
  

    <time class="dt-published" datetime="2024-07-18T22:00:00.000Z">
  <span class="day">19</span><span class="month">Jul</span>
</time>
  </header>
  <div class="e-content entry-content">
    
      <p>Hi all,<br>As someone who’s spent countless hours setting up and managing infrastructure, I know how tedious and error-prone it can be to create a kubernetes clusters on different environments or service providers. But what if I told you there’s a way to make this process a whole lot easier? Enter Terraform - a powerful tool for automating infrastructure deployment - which many of you readers may already be aware of. So let’s skip the broad introduction and get right into the details.</p>
<br />
<img src="/2024/07/19/2024-07-19-terraform-proxmox-kubernetes-module/header.png" class="" title="header">
<br />

<p>First the module is available on Github under the following domain: <a target="_blank" rel="noopener" href="https://github.com/deB4SH/terraform-proxmox-cloud-init-kubernetes">https://github.com/deB4SH/terraform-proxmox-cloud-init-kubernetes</a></p>
<h3 id="What-does-this-module-do"><a href="#What-does-this-module-do" class="headerlink" title="What does this module do?"></a>What does this module do?</h3><p>This Terraform module takes care of creating a Kubernetes cluster on proxmox using cloud-init and kubeadm. </p>
<p>With it, you’ll be able to:</p>
<ul>
<li>Automate the creation of a Kubernetes cluster with just a few variables</li>
<li>Customize the scale of your cluster</li>
</ul>
<blockquote>
<p><strong>Important Sidenote</strong>: currently the module is not able to scale up multiple control planes - I’m planning to implement it down the road.</p>
</blockquote>
<h3 id="How-does-everything-work"><a href="#How-does-everything-work" class="headerlink" title="How does everything work?"></a>How does everything work?</h3><p>The module is pretty much ready to run on your infrastructure you simply need to configure some values.<br>Within the <code>variables.tf</code> you can easily review all available configuration: <a target="_blank" rel="noopener" href="https://github.com/deB4SH/terraform-proxmox-cloud-init-kubernetes/blob/main/variables.tf">https://github.com/deB4SH/terraform-proxmox-cloud-init-kubernetes/blob/main/variables.tf</a><br>For example a value you need to overlay is the <code>user_password</code> and <code>user_pub_key</code> to automatically add your credentials to each vm. </p>
<p>A typical configuration based on this module may look like the following listing:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">module &quot;kubernetes&quot; &#123;</span><br><span class="line">  providers = &#123;</span><br><span class="line">    proxmox = proxmox.YOUR_NODE_NAME</span><br><span class="line">  &#125;</span><br><span class="line">  source = &quot;github.com/deB4SH/terraform-proxmox-cloud-init-kubernetes?ref=0.1&quot;</span><br><span class="line"></span><br><span class="line">  user = var.user</span><br><span class="line">  user_password = var.user_password</span><br><span class="line">  user_pub_key = var.user_pub_key</span><br><span class="line">  node_name = var.YOUR_NODE_NAME.node_name</span><br><span class="line"></span><br><span class="line">  vm_dns = &#123;</span><br><span class="line">    domain = &quot;.&quot;</span><br><span class="line">    servers = [&quot;10.10.10.2&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  vm_ip_config = &#123;</span><br><span class="line">    address = &quot;10.10.10.10/24&quot;</span><br><span class="line">    gateway = &quot;10.10.10.1&quot;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  vm_datastore_id = &quot;local-lvm&quot;</span><br><span class="line"></span><br><span class="line">  workers = [</span><br><span class="line">    &#123;</span><br><span class="line">      node = &quot;YOUR_NODE_NAME&quot;</span><br><span class="line">      name = &quot;worker01&quot;</span><br><span class="line">      vm_cpu_cores = 6</span><br><span class="line">      vm_memory = 12288</span><br><span class="line">      ip = &quot;10.10.10.11/24&quot;</span><br><span class="line">      id_offset = 1</span><br><span class="line">      image_type = &quot;amd64&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line"></span><br><span class="line">  vm_images = [ </span><br><span class="line">  &#123;</span><br><span class="line">    name = &quot;amd64&quot;</span><br><span class="line">    filename = &quot;kubernetes-debian-12-generic-amd64-20240507-1740.img&quot;</span><br><span class="line">    url = &quot;https://cloud.debian.org/images/cloud/bookworm/20240507-1740/debian-12-generic-amd64-20240507-1740.qcow2&quot;</span><br><span class="line">    checksum = &quot;f7ac3fb9d45cdee99b25ce41c3a0322c0555d4f82d967b57b3167fce878bde09590515052c5193a1c6d69978c9fe1683338b4d93e070b5b3d04e99be00018f25&quot;</span><br><span class="line">    checksum_algorithm = &quot;sha512&quot;</span><br><span class="line">    datastore_id = &quot;nas&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    name = &quot;arm64&quot;</span><br><span class="line">    filename = &quot;kubernetes-debian-12-generic-arm64-20240507-1740.img&quot;</span><br><span class="line">    url = &quot;https://cloud.debian.org/images/cloud/bookworm/20240507-1740/debian-12-generic-arm64-20240507-1740.qcow2&quot;</span><br><span class="line">    checksum = &quot;626a4793a747b334cf3bc1acc10a5b682ad5db41fabb491c9c7062001e5691c215b2696e02ba6dd7570652d99c71c16b5f13b694531fb1211101d64925a453b8&quot;</span><br><span class="line">    checksum_algorithm = &quot;sha512&quot;</span><br><span class="line">    datastore_id = &quot;nas&quot;</span><br><span class="line">  &#125;</span><br><span class="line">  ]</span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>To break things down. The provider block configures the proxmox endpoint you using to do the api calls to. For a overview how to use this provider please review the official documentation here: <a target="_blank" rel="noopener" href="https://registry.terraform.io/providers/bpg/proxmox/latest/docs">https://registry.terraform.io/providers/bpg/proxmox/latest/docs</a><br>The source block configures the module to use. In this case we are referencing version 0.1 of the module. Don’t be confused by this version - it’s just a development number for now.</p>
<p>The following blocks are delegated blocks towards each vm and configure their respective parts. For example the dns block configures the available dns the vm should use.<br><code>vm_ip_config</code> describes currently the ip address of the control plane. This will change in future when this module allows multiple control planes. </p>
<p>The list around the configuration value for <code>workers</code> describe the amount of vms you want to create as worker nodes for your cluster. </p>
<p>Last but not least: You are able to configure multiple vm images for amd64 and or arm. It would also be possible to inject different images for workers this way.</p>
<h3 id="What-are-you-getting-after-a-successful-deployment"><a href="#What-are-you-getting-after-a-successful-deployment" class="headerlink" title="What are you getting after a successful deployment"></a>What are you getting after a successful deployment</h3><p>Well a barebones kubernetes cluster. No networking. No fancy load balancing pods. Pretty much nothing. A blank slate to work on.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">KUBECONFIG=config k get nodes  </span><br><span class="line">NAME                      STATUS     ROLES           AGE     VERSION  </span><br><span class="line">kubernetes-controlplane   NotReady   control-plane   5m21s   v1.30.2  </span><br><span class="line">worker01                  NotReady   &lt;none&gt;          106s    v1.30.2</span><br></pre></td></tr></table></figure>

<p>A good next step would be adding a network component to your cluster.<br>I like cilium and prepared an umbrella helm-chart for this setup in my helm-charts repository. Available here: <a target="_blank" rel="noopener" href="https://github.com/deB4SH/helm-charts/tree/main/charts/cilium">https://github.com/deB4SH/helm-charts/tree/main/charts/cilium</a><br>After a successful apply your nodes should become ready for workloads.</p>
<h3 id="What’s-next-for-this-module"><a href="#What’s-next-for-this-module" class="headerlink" title="What’s next for this module?"></a>What’s next for this module?</h3><p>Good question! There are several things this module is currently missing out on. </p>
<p>First thing - it would be awesome if this module also allows you to create highly available kubernetes clusters with multiple control planes<br>It would also be awesome if there is some configuration available to automatically join a new cluster towards existing gitops solutions like argocd or flux to automatically apply services like cilium, external-dns, external-secrets or sops any many more.<br>Lastly: this module may be a bit cluttered configuration-wise and doesn’t follow any particular standard currently. Standardizing this would surely improve configurability and ease up the usage.</p>
<p>As always - I’m hoping this blog post helps others to get your toes into the big blue ocean of platform engineering on proxmox with kubeadm.</p>
<h5 id="Sources"><a href="#Sources" class="headerlink" title="Sources"></a>Sources</h5><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/deB4SH/terraform-proxmox-cloud-init-kubernetes">Terraform Module Proxmox Kubernetes</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/deB4SH/helm-charts">Helm Charts Repository</a></li>
<li><a target="_blank" rel="noopener" href="https://registry.terraform.io/providers/bpg/proxmox/latest/docs">Terraform Provider Proxmox</a></li>
<li><a target="_blank" rel="noopener" href="https://cilium.io/">Cilium</a></li>
</ul>

    
    
    <footer class="meta">
      
      
  <div class="tags">
<a href="/tags/terraform/">terraform</a><a href="/tags/tf/">tf</a><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/opentofu/">opentofu</a><a href="/tags/terraform-module/">terraform module</a><a href="/tags/proxmox/">proxmox</a></div>

      
    </footer>
    
      

    
    
  </div>
  
</article>
</div>
  <footer id="footer" class="inner"><div class="social alignright">
  
  
  
    <a class="github" target="_blank" rel="noopener" href="https://github.com/deb4sh" title="GitHub">GitHub</a>
  
  <a class="rss" href="/atom.xml" title="RSS">RSS</a>
</div>
<p>
  
  &copy; 2024 deB4SH
  
</p>
<div class="clearfix"></div></footer>
  
<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/jquery.imagesloaded.min.js"></script>


<script src="/js/gallery.js"></script>






<script src="/fancybox/jquery.fancybox.min.js"></script>

<script>
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<div id="phasebeam">
  <canvas></canvas>
  <canvas></canvas>
  <canvas></canvas>
</div>

<script src="/js/phasebeam.js"></script>

</body>
</html>