<!DOCTYPE html>
 <html lang="en"> 
<head>
  <meta charset="utf-8">
  
  <title>DevOpsStories - Victoria Metrics Setup | log.out(&#34;blog&#34;)</title>
  <meta name="author" content="deB4SH">

  
  <meta name="description" content="a journey between software and ops topics">
  

  
  
<link rel="stylesheet" href="/css/style.css">

  
  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  <!--[if lt IE 9]><script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script><![endif]-->
  
<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 5.4.2"></head>

<body>
  <header id="header" class="inner"><nav>
  <ul>
    
      <li><a href="/">Home</a></li>
    
      <li><a href="/archives">Archives</a></li>
    
  </ul>
</nav></header>
  <div id="content" class="inner"><article class="h-entry post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  
    <div class="gallery">
  <div class="photoset">
    
      <img src="">
    
  </div>
  <div class="control">
    <div class="prev"></div>
    <div class="next"></div>
  </div>
</div>
  
  <header>
    
  
    <h1 class="p-name title" itemprop="headline name">DevOpsStories - Victoria Metrics Setup</h1>
  

    <time class="dt-published" datetime="2023-04-05T22:00:00.000Z">
  <span class="day">6</span><span class="month">Apr</span>
</time>
  </header>
  <div class="e-content entry-content">
    
      <p>Hi all,<br>as some of you may know, I’m interested in homelabbing and are hosting my own kubernetes cluster at home. As part of a good homelab it is essential to keep track of logs and metrics.<br>The number one goto application for this usecase is often the kube Prometheus Stack, which is in my humble opinion a bit to big for my homelab in regard to memory, compute and storage footprint.<br>While looking for alternatives I stumbled upon <a target="_blank" rel="noopener" href="https://victoriametrics.com/">Victoria Metrics</a> which seems to be a perfect fit for my usecase.</p>
<p>It is build in a distributed fashion with a time-series storage ind mind. From my first view at the architectural view it looks quite fitting for my usecase and could be a nice general drop-in replacement for the Prometheus stack.<br><img src="https://docs.victoriametrics.com/Cluster-VictoriaMetrics_cluster-scheme.png" alt="Victoria Metrics Architecture View"><br>Source: <a target="_blank" rel="noopener" href="https://docs.victoriametrics.com/Cluster-VictoriaMetrics.html">Docs Victoria Metrics</a></p>
<p>So let’s get started in jump into the deep water and build our deployments.</p>
<p>A prepared example deployment is available <a target="_blank" rel="noopener" href="https://github.com/deB4SH/Kustomize-Victoria-Metrics">here</a></p>
<h1 id="Victoria-Metrics-Cluster"><a href="#Victoria-Metrics-Cluster" class="headerlink" title="Victoria Metrics Cluster"></a>Victoria Metrics Cluster</h1><p>The cluster deployment is composed of the official helm-chart made available and contains the three root components vmselect, vminsert and vmstorage.</p>
<p>VMStorage is the data backend for all stored metrics and is the single golden trough for your queryable data in a time range. Due to the fact that the vmstorage component manages raw data it becomes a stateful part of your cluster, which is requiring some sort of special care.<br>VMInset and VMSelect are both stateless components in this stack and provide your third party applications access towards the raw data you are collecting in your cluster. </p>
<p>Installing the metrics cluster is rather easy due to the provided helm chart, which is easiest to view via <a target="_blank" rel="noopener" href="https://artifacthub.io/packages/helm/victoriametrics/victoria-metrics-cluster">ArtifactHub</a>.<br>At the time of writing this blog post version 0.9.60 is the newest and everything is based on this.</p>
<p>To reduce the tool dependency, I’m going to use the <a target="_blank" rel="noopener" href="https://kubectl.docs.kubernetes.io/references/kustomize/builtins/#_helmchartinflationgenerator_">HelmChartInflationGenerator</a> for kustomize to keep everything in one <em>universe</em>.</p>
<p>First, we need to set up the inflation generator for this specific helm chart. </p>
<blockquote>
<p>./base/victoria-metrics-cluster/helmrelease.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">builtin</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HelmChartInflationGenerator</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">victoria-metrics-cluster</span></span><br><span class="line"><span class="attr">releaseName:</span> <span class="string">victoria-metrics-cluster</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">victoria-metrics-cluster</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">0.9</span><span class="number">.60</span></span><br><span class="line"><span class="attr">repo:</span> <span class="string">https://victoriametrics.github.io/helm-charts/</span></span><br><span class="line"><span class="attr">valuesInline:</span> &#123;&#125;</span><br><span class="line"><span class="attr">IncludeCRDs:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">victoria-metrics</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>./base/victoria-metrics-cluster/kustomization.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kustomize.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kustomization</span></span><br><span class="line"></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">helmrelease.yaml</span></span><br></pre></td></tr></table></figure>

<p>The general information is pretty straight forward if you are already familiar with the helm-way to install prepared packages.<br>You may notice that the <strong>valuesInline</strong> are empty.<br>Due to the fact that I wanted to set up this deployment in a <em>patch-able</em> manor, the value overwrites are added with the next step.</p>
<blockquote>
<p>./env/homelab/patches/patch-victoria-metrics-cluster.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">builtin</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HelmChartInflationGenerator</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">victoria-metrics-cluster</span></span><br><span class="line"><span class="attr">valuesInline:</span> </span><br><span class="line">  <span class="attr">rbac:</span></span><br><span class="line">    <span class="attr">create:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">pspEnabled:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">vmselect:</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">podAnnotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">&quot;8481&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">vminsert:</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">podAnnotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">&quot;8480&quot;</span></span><br><span class="line">    <span class="attr">extraArgs:</span></span><br><span class="line">      <span class="attr">envflag.enable:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">envflag.prefix:</span> <span class="string">VM_</span></span><br><span class="line">      <span class="attr">loggerFormat:</span> <span class="string">json</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">vmstorage:</span></span><br><span class="line">    <span class="attr">replicaCount:</span> <span class="number">1</span></span><br><span class="line">    <span class="attr">persistentVolume:</span></span><br><span class="line">      <span class="attr">storageClass:</span> <span class="string">nfs-client</span></span><br><span class="line">    <span class="attr">podAnnotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">        <span class="attr">prometheus.io/port:</span> <span class="string">&quot;8482&quot;</span></span><br></pre></td></tr></table></figure>

<p>This patch applies modifications towards the helm chart which are generally available via the preconfigured values within it.<br>To elaborate my specific patch.<br>I wanted to create specific RBAC rules for my environment but was required to disable the pod security policies, due to the fact that these were removed in Kubernetes 1.25.<br>Besides that, I have set for each component a replication count of one to reduce the load on my environment and configured the pod annotations so that metrics are collected afterward.</p>
<blockquote>
<p>NOTE: If you are going to use my example configuration. Please consider changing the storageClass, which may or may not be available in your infrastructure.</p>
</blockquote>
<p>To collect both manifests, it is required to add an another kustomization with the following content.</p>
<blockquote>
<p>./env/homelab/kustomization.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kustomize.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kustomization</span></span><br><span class="line"></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">victoria-metrics</span></span><br><span class="line"></span><br><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">../../base/victoria-metrics-cluster</span></span><br><span class="line"></span><br><span class="line"><span class="attr">patchesStrategicMerge:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">patches/patch-victoria-metrics-cluster.yaml</span></span><br></pre></td></tr></table></figure>

<p>Using the HelmChartInflationGenerator within kustomize is currently a bit tricky and requires a special third kustomization which <em>loads</em> the second kustomization as generator module.</p>
<blockquote>
<p>./generators/homelab/kustomization.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">kustomize.config.k8s.io/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Kustomization</span></span><br><span class="line"></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">victoria-metrics</span></span><br><span class="line"></span><br><span class="line"><span class="attr">generators:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">../../env/homelab/</span></span><br></pre></td></tr></table></figure>

<p>With this setup, you are able to deploy the cluster deployment with any cicd approach or even a gitops approach. </p>
<p>If you are working with argocd to deploy this kustomization you need to add a <em>plugin</em> within your argocd-cm configmap and reference it within the plugin block in your application.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">argocd-cm</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">configManagementPlugins:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    - name: kustomize-build-with-helm</span></span><br><span class="line"><span class="string">      generate:</span></span><br><span class="line"><span class="string">        command: [ &quot;sh&quot;, &quot;-c&quot; ]</span></span><br><span class="line"><span class="string">        args: [ &quot;kustomize build --enable-helm&quot; ]</span></span><br></pre></td></tr></table></figure>

<h1 id="Victoria-Metrics-Agent"><a href="#Victoria-Metrics-Agent" class="headerlink" title="Victoria Metrics Agent"></a>Victoria Metrics Agent</h1><p>Now with the cluster running, it is time to collect the first metrics from within the Kubernetes cluster. For this, it is possible to install the victoria metrics agent, which is also provided by a helm chart. </p>
<p>The agent is a tiny software that collects metrics from various sources and writes them towards the configure remote address.</p>
<p><img src="https://docs.victoriametrics.com/vmagent.png" alt="Victoria Metrics Agent Overview"><br>Source: <a target="_blank" rel="noopener" href="https://docs.victoriametrics.com/vmagent.html">Victoria Metrics Documentation - VMagent</a></p>
<p>As first step, it is required to configure the helm inflation generator again. </p>
<blockquote>
<p>./base/victoria-metrics-agent/helmrelease.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">builtin</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HelmChartInflationGenerator</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">victoria-metrics-agent</span></span><br><span class="line"><span class="attr">releaseName:</span> <span class="string">victoria-metrics-agent</span> </span><br><span class="line"><span class="attr">name:</span> <span class="string">victoria-metrics-agent</span> </span><br><span class="line"><span class="attr">version:</span> <span class="number">0.8</span><span class="number">.29</span></span><br><span class="line"><span class="attr">repo:</span> <span class="string">https://victoriametrics.github.io/helm-charts/</span></span><br><span class="line"><span class="attr">valuesInline:</span> &#123;&#125;</span><br><span class="line"><span class="attr">IncludeCRDs:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">victoria-metrics</span></span><br></pre></td></tr></table></figure>

<p>Equally, to the cluster deployment, a initial kustomization is required to collect all manifest together and prepare them for patches.</p>
<p>As next step, the patch configuration is required to configure the agent with this deployment. </p>
<blockquote>
<p>NOTE: This is a rather big patch and will be partly explained afterward</p>
</blockquote>
<blockquote>
<p>./env/homelab/patches/patch-victoria-metrics-agent.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">builtin</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HelmChartInflationGenerator</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">victoria-metrics-agent</span></span><br><span class="line"><span class="attr">valuesInline:</span> </span><br><span class="line">  <span class="attr">rbac:</span></span><br><span class="line">    <span class="attr">pspEnabled:</span> <span class="literal">false</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">deployment:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">statefulset:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">remoteWriteUrls:</span></span><br><span class="line">   <span class="bullet">-</span> <span class="string">http://victoria-metrics-cluster-vminsert.victoria-metrics:8480/insert/0/prometheus/</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">global:</span></span><br><span class="line">      <span class="attr">scrape_interval:</span> <span class="string">10s</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">scrape_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">vmagent</span></span><br><span class="line">        <span class="attr">static_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&quot;localhost:8429&quot;</span>]</span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;kubernetes-apiservers&quot;</span></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">          <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">              [</span><br><span class="line">                <span class="string">__meta_kubernetes_namespace</span>,</span><br><span class="line">                <span class="string">__meta_kubernetes_service_name</span>,</span><br><span class="line">                <span class="string">__meta_kubernetes_endpoint_port_name</span>,</span><br><span class="line">              ]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">default;kubernetes;https</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;kubernetes-nodes&quot;</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">          <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">            <span class="attr">replacement:</span> <span class="string">kubernetes.default.svc:443</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">            <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">            <span class="attr">replacement:</span> <span class="string">/api/v1/nodes/$1/proxy/metrics</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;kubernetes-nodes-cadvisor&quot;</span></span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">https</span></span><br><span class="line">        <span class="attr">tls_config:</span></span><br><span class="line">          <span class="attr">ca_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line">          <span class="attr">insecure_skip_verify:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">bearer_token_file:</span> <span class="string">/var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">node</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">__meta_kubernetes_node_label_(.+)</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">            <span class="attr">replacement:</span> <span class="string">kubernetes.default.svc:443</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_node_name</span>]</span><br><span class="line">            <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">            <span class="attr">replacement:</span> <span class="string">/api/v1/nodes/$1/proxy/metrics/cadvisor</span></span><br><span class="line">        <span class="attr">metric_relabel_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">source_labels:</span> [<span class="string">pod</span>]</span><br><span class="line">            <span class="attr">regex:</span> <span class="string">&#x27;(.+)&#x27;</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">pod_name</span></span><br><span class="line">            <span class="attr">replacement:</span> <span class="string">&#x27;$&#123;1&#125;&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">source_labels:</span> [<span class="string">container</span>]</span><br><span class="line">            <span class="attr">regex:</span> <span class="string">&#x27;(.+)&#x27;</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">container_name</span></span><br><span class="line">            <span class="attr">replacement:</span> <span class="string">&#x27;$&#123;1&#125;&#x27;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">name</span></span><br><span class="line">            <span class="attr">replacement:</span> <span class="string">k8s_stub</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">source_labels:</span> [<span class="string">id</span>]</span><br><span class="line">            <span class="attr">regex:</span> <span class="string">&#x27;^/system\.slice/(.+)\.service$&#x27;</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">systemd_service_name</span></span><br><span class="line">            <span class="attr">replacement:</span> <span class="string">&#x27;$&#123;1&#125;&#x27;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;kubernetes-service-endpoints&quot;</span></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">            <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_container_init</span>]</span><br><span class="line">            <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">keep_if_equal</span></span><br><span class="line">            <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>, <span class="string">__meta_kubernetes_pod_container_port_number</span>]</span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">              [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scrape</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">              [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scheme</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">__scheme__</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">(https?)</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">              [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_path</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">              [</span><br><span class="line">                <span class="string">__address__</span>,</span><br><span class="line">                <span class="string">__meta_kubernetes_service_annotation_prometheus_io_port</span>,</span><br><span class="line">              ]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">            <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_node_name</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">kubernetes_node</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;kubernetes-service-endpoints-slow&quot;</span></span><br><span class="line">        <span class="attr">scrape_interval:</span> <span class="string">5m</span></span><br><span class="line">        <span class="attr">scrape_timeout:</span> <span class="string">30s</span></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">endpoints</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">            <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_container_init</span>]</span><br><span class="line">            <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">keep_if_equal</span></span><br><span class="line">            <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>, <span class="string">__meta_kubernetes_pod_container_port_number</span>]</span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">              [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scrape_slow</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">              [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_scheme</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">__scheme__</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">(https?)</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">              [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_path</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">              [</span><br><span class="line">                <span class="string">__address__</span>,</span><br><span class="line">                <span class="string">__meta_kubernetes_service_annotation_prometheus_io_port</span>,</span><br><span class="line">              ]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">            <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_node_name</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">kubernetes_node</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;kubernetes-services&quot;</span></span><br><span class="line">        <span class="attr">metrics_path:</span> <span class="string">/probe</span></span><br><span class="line">        <span class="attr">params:</span></span><br><span class="line">          <span class="attr">module:</span> [<span class="string">http_2xx</span>]</span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">service</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">              [<span class="string">__meta_kubernetes_service_annotation_prometheus_io_probe</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__address__</span>]</span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">__param_target</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">            <span class="attr">replacement:</span> <span class="string">blackbox</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__param_target</span>]</span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">instance</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">__meta_kubernetes_service_label_(.+)</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_service_name</span>]</span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">kubernetes_name</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&quot;kubernetes-pods&quot;</span></span><br><span class="line">        <span class="attr">kubernetes_sd_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">pod</span></span><br><span class="line">        <span class="attr">relabel_configs:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">drop</span></span><br><span class="line">            <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_container_init</span>]</span><br><span class="line">            <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">keep_if_equal</span></span><br><span class="line">            <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>, <span class="string">__meta_kubernetes_pod_container_port_number</span>]</span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_scrape</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">keep</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="literal">true</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_annotation_prometheus_io_path</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">__metrics_path__</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">(.+)</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span></span><br><span class="line">              [<span class="string">__address__</span>, <span class="string">__meta_kubernetes_pod_annotation_prometheus_io_port</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line">            <span class="attr">replacement:</span> <span class="string">$1:$2</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">__address__</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">action:</span> <span class="string">labelmap</span></span><br><span class="line">            <span class="attr">regex:</span> <span class="string">__meta_kubernetes_pod_label_(.+)</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_namespace</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">kubernetes_namespace</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">source_labels:</span> [<span class="string">__meta_kubernetes_pod_name</span>]</span><br><span class="line">            <span class="attr">action:</span> <span class="string">replace</span></span><br><span class="line">            <span class="attr">target_label:</span> <span class="string">kubernetes_pod_name</span></span><br></pre></td></tr></table></figure>
<p>Most of the beforehand patch is the configuration for the agent to scrape targets and can be <em>ignored</em> or copied. The important parts are the first few lines.<br>With the <em>remoteWriteUrls</em> an external data source is configured. Due to the fact that both services are running side-by-side in a single cluster, it is possible to use the cluster ip to route this traffic internally. </p>
<p>Both manifest locations added towards the environment overlay kustomization and the cicd environment should automatically install the agent. </p>
<h1 id="Grafana"><a href="#Grafana" class="headerlink" title="Grafana"></a>Grafana</h1><p>Building a collection of metrics is just one side of the medallion. The other side is displaying and reacting to changing metrics.<br>As always, start with a helm chart inflation.</p>
<blockquote>
<p>./base/grafana/helmrelease.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">builtin</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HelmChartInflationGenerator</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">releaseName:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">version:</span> <span class="number">6.50</span><span class="number">.5</span></span><br><span class="line"><span class="attr">repo:</span> <span class="string">https://grafana.github.io/helm-charts</span></span><br><span class="line"><span class="attr">valuesInline:</span> &#123;&#125;</span><br><span class="line"><span class="attr">IncludeCRDs:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">namespace:</span> <span class="string">victoria-metrics</span></span><br></pre></td></tr></table></figure>

<p>The next step is to add the patch for Grafana.<br>With the following patch, the deployment will be configured to the desired environment. For example, the ingress configuration provides all required information to access Grafana afterward. </p>
<p>The important part is the datasource configuration that provides the link between Grafana and the installed victoria metrics cluster.<br>The VMSelect application provides a dropin replacement Prometheus endpoint for Grafana to be consumed. </p>
<p>One downside of this used helm chart is that there is currently no support for a configuration reload sidecar container that refreshes the dashboards and configuration located in Kubernetes. Therefor, it is required to configure the default available dashboards within the dashboards block. </p>
<blockquote>
<p>./env/homelab/patches/patch-grafana.yaml</p>
</blockquote>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">builtin</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HelmChartInflationGenerator</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">grafana</span></span><br><span class="line"><span class="attr">valuesInline:</span> </span><br><span class="line">  <span class="attr">datasources:</span></span><br><span class="line">    <span class="attr">datasources.yaml:</span></span><br><span class="line">      <span class="attr">apiVersion:</span> <span class="number">1</span></span><br><span class="line">      <span class="attr">datasources:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">victoriametrics</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="attr">orgId:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">url:</span> <span class="string">http://victoria-metrics-cluster-vmselect.victoria-metrics:8481/select/0/prometheus/</span></span><br><span class="line">          <span class="attr">access:</span> <span class="string">proxy</span></span><br><span class="line">          <span class="attr">isDefault:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">updateIntervalSeconds:</span> <span class="number">10</span></span><br><span class="line">          <span class="attr">editable:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">dashboardProviders:</span></span><br><span class="line">   <span class="attr">dashboardproviders.yaml:</span></span><br><span class="line">     <span class="attr">apiVersion:</span> <span class="number">1</span></span><br><span class="line">     <span class="attr">providers:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;default&#x27;</span></span><br><span class="line">       <span class="attr">orgId:</span> <span class="number">1</span></span><br><span class="line">       <span class="attr">folder:</span> <span class="string">&#x27;&#x27;</span></span><br><span class="line">       <span class="attr">type:</span> <span class="string">file</span></span><br><span class="line">       <span class="attr">disableDeletion:</span> <span class="literal">true</span></span><br><span class="line">       <span class="attr">editable:</span> <span class="literal">true</span></span><br><span class="line">       <span class="attr">options:</span></span><br><span class="line">         <span class="attr">path:</span> <span class="string">/var/lib/grafana/dashboards/default</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">dashboards:</span></span><br><span class="line">    <span class="attr">default:</span></span><br><span class="line">      <span class="attr">victoriametrics:</span></span><br><span class="line">        <span class="attr">gnetId:</span> <span class="number">11176</span></span><br><span class="line">        <span class="attr">revision:</span> <span class="number">18</span></span><br><span class="line">        <span class="attr">datasource:</span> <span class="string">victoriametrics</span></span><br><span class="line">      <span class="attr">vmagent:</span></span><br><span class="line">        <span class="attr">gnetId:</span> <span class="number">12683</span></span><br><span class="line">        <span class="attr">revision:</span> <span class="number">7</span></span><br><span class="line">        <span class="attr">datasource:</span> <span class="string">victoriametrics</span></span><br><span class="line">      <span class="attr">kubernetes:</span></span><br><span class="line">        <span class="attr">gnetId:</span> <span class="number">14205</span></span><br><span class="line">        <span class="attr">revision:</span> <span class="number">1</span></span><br><span class="line">        <span class="attr">datasource:</span> <span class="string">victoriametrics</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">ingress:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">annotations:</span></span><br><span class="line">      <span class="attr">cert-manager.io/cluster-issuer:</span> <span class="string">selfsigned-ca-issuer</span></span><br><span class="line">      <span class="attr">kubernetes.io/ingress.class:</span> <span class="string">traefik</span></span><br><span class="line">      <span class="attr">traefik.ingress.kubernetes.io/router.entrypoints:</span> <span class="string">web,</span> <span class="string">websecure</span></span><br><span class="line">      <span class="attr">traefik.ingress.kubernetes.io/router.tls:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">      <span class="attr">ingress.kubernetes.io/ssl-force-host:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">      <span class="attr">ingress.kubernetes.io/ssl-redirect:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">hosts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">grafana.lan</span></span><br><span class="line">    <span class="attr">tls:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="attr">secretName:</span> <span class="string">grafana.lan</span></span><br><span class="line">       <span class="attr">hosts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">grafana.lan</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">128Mi</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">128Mi</span></span><br></pre></td></tr></table></figure>

<p>Adding all folder and resources to their relevant kustomizations, and you should be welcomed with a semi-complete monitoring stack for your Kubernetes environment. Missing components like the node-exporter could easily be added to the same deployment process with the already shown approach.</p>
<p>As a small reminder: the complete deployment is described within the prepared repository under the following url <a target="_blank" rel="noopener" href="https://github.com/deB4SH/Kustomize-Victoria-Metrics">https://github.com/deB4SH/Kustomize-Victoria-Metrics</a>.</p>

    
    
    <footer class="meta">
      
      
  <div class="tags">
<a href="/tags/devops/">devops</a><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/kustomize/">kustomize</a><a href="/tags/helm-chart/">helm chart</a><a href="/tags/helm/">helm</a><a href="/tags/k8s/">k8s</a><a href="/tags/argocd/">argocd</a><a href="/tags/multicluster/">multicluster</a><a href="/tags/helmchartinflationgenerator/">helmchartinflationgenerator</a><a href="/tags/kustomize-helmchartinflationgenerator/">kustomize helmchartinflationgenerator</a></div>

      
    </footer>
    
      

    
    
  </div>
  
</article>
</div>
  <footer id="footer" class="inner"><div class="social alignright">
  
  
  
    <a class="github" target="_blank" rel="noopener" href="https://github.com/deb4sh" title="GitHub">GitHub</a>
  
  <a class="rss" href="/atom.xml" title="RSS">RSS</a>
</div>
<p>
  
  &copy; 2024 deB4SH
  
</p>
<div class="clearfix"></div></footer>
  
<script src="/js/jquery-3.4.1.min.js"></script>


<script src="/js/jquery.imagesloaded.min.js"></script>


<script src="/js/gallery.js"></script>






<script src="/fancybox/jquery.fancybox.min.js"></script>

<script>
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>


<div id="phasebeam">
  <canvas></canvas>
  <canvas></canvas>
  <canvas></canvas>
</div>

<script src="/js/phasebeam.js"></script>

</body>
</html>